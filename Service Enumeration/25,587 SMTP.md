## nmap SMTP scripts
```bash
nmap --script=smtp-* -p 25,587 $IP
```

## Verify user with VRFY command
```bash
echo "VRFY root" | nc -nv $IP 25
```

## Expand mailing list with EXPN command
```bash
echo "EXPN root" | nc -nv $IP 25
```

## Enumerate users with smtp-user-enum (VRFY)
```bash
smtp-user-enum -M VRFY -U /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -t $IP
```

## Enumerate users with smtp-user-enum (EXPN)
```bash
smtp-user-enum -M EXPN -U /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -t $IP
```

## Enumerate users with smtp-user-enum (RCPT TO)
```bash
smtp-user-enum -M RCPT -U /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -t $IP
```

## Connect to STARTTLS SMTP with openssl
```bash
openssl s_client -starttls smtp -connect $IP:25
```

## Connect to SMTPS with openssl
```bash
openssl s_client -connect $IP:587
```

## Brute force SMTP authentication with hydra
```bash
hydra -l admin -P /usr/share/wordlists/rockyou.txt -s 25 smtp://$IP
```

---

# SMTP Enumeration Methodology

## Initial Reconnaissance

1. Identify SMTP service on port 25 (or 587 for submission)
2. Grab banner to identify mail server software and version
3. Test for user enumeration (VRFY, EXPN, RCPT TO)
4. Check for open relay
5. Test authentication if enabled
6. Look for vulnerabilities in identified software version

## SMTP Banner Grabbing

**Why it matters:**
The banner reveals:
- Mail server software (Postfix, Sendmail, Exchange, etc.)
- Version number
- Hostname

**Match version to CVEs:**
Once you know the software and version, check for known vulnerabilities.

## User Enumeration Methods

**VRFY (Verify):**
Confirms if a mailbox exists. Returns different responses for valid/invalid users.

**Example:**
```
VRFY root
250 root@target.com
```

**EXPN (Expand):**
Expands mailing lists/aliases. May reveal multiple addresses.

**Example:**
```
EXPN admin
250 administrator@target.com
250 sysadmin@target.com
```

**RCPT TO (Recipient):**
Used during mail transaction. Accepts/rejects recipients based on existence.

**Example:**
```
MAIL FROM: test@attacker.com
250 OK
RCPT TO: root@target.com
250 OK (user exists)
RCPT TO: invalid@target.com
550 User not found
```

## Automated User Enumeration

**smtp-user-enum tool:**
Automates testing usernames against VRFY, EXPN, or RCPT TO commands.

**Best wordlists:**
- /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt
- /usr/share/wordlists/seclists/Usernames/Names/names.txt

**Output:**
List of valid email addresses/usernames for password attacks.

## Open Relay Testing

**What is open relay:**
Misconfigured mail server that forwards mail for any sender/recipient. Can be abused for spam or phishing.

**Testing manually:**
```
telnet $IP 25
HELO attacker.com
MAIL FROM: attacker@evil.com
RCPT TO: victim@target.com
DATA
Subject: Test
Testing open relay
.
QUIT
```

**If accepted:**
Server is an open relay. Document but don't abuse.

## SMTP Commands

**Basic SMTP session:**
```
HELO/EHLO: Identify yourself
MAIL FROM: Set sender
RCPT TO: Set recipient
DATA: Message content (end with . on new line)
QUIT: Close connection
VRFY: Verify user
EXPN: Expand list
HELP: Show available commands
```

**EHLO vs HELO:**
EHLO (Extended HELO) shows server capabilities including STARTTLS and AUTH.

## SMTP Authentication

**AUTH command:**
If server supports authentication, you can attempt login.

**Manual AUTH LOGIN:**
```
telnet $IP 25
EHLO attacker.com
AUTH LOGIN
(base64 encoded username)
(base64 encoded password)
```

**Encoding credentials:**
```bash
echo -n "username" | base64
echo -n "password" | base64
```

## STARTTLS and Encryption

**STARTTLS:**
Upgrades plaintext connection to TLS encryption on port 25 or 587.

**Testing with openssl:**
```bash
openssl s_client -starttls smtp -connect $IP:25
```

**SMTPS (port 465):**
SMTP over SSL from the start (deprecated but still used).

**Check certificate:**
Look for certificate errors, expired certs, or hostname mismatches.

## Brute Force Authentication

**When to use:**
- Only after other methods fail
- With small, targeted wordlists
- When account lockout policy is known

**Tools:**
- hydra: Reliable, supports SMTP
- patator: More flexible
- medusa: Alternative option

**Be careful:**
SMTP brute force is slow and highly logged.

## Mail File Access

**If you gain system access:**

**Common mail directories:**
- /var/mail/
- /var/spool/mail/
- /home/*/Maildir/
- /home/*/mail/

**Mail logs:**
- /var/log/mail.log
- /var/log/maillog

**Why check mail files:**
- Passwords in emails
- Sensitive information
- User correspondence
- System notifications with details

## Enumeration Checklist

- [ ] Banner grabbing and version identification
- [ ] VRFY command user enumeration
- [ ] EXPN command mailing list enumeration
- [ ] RCPT TO user enumeration
- [ ] Open relay testing
- [ ] SMTP AUTH brute force (if enabled)
- [ ] STARTTLS security testing
- [ ] Command injection testing
- [ ] Mail file access (if system compromised)

## Common Misconfigurations

1. **VRFY/EXPN enabled** (allows user enumeration)
2. **Open relay** configuration
3. **No authentication required** for sending
4. **Weak authentication** credentials
5. **Outdated software** with known CVEs
6. **No TLS/encryption** for sensitive emails

---

# References

- https://book.hacktricks.xyz/network-services-pentesting/pentesting-smtp
- https://www.samlogic.net/articles/smtp-commands-reference.htm
- https://tools.ietf.org/html/rfc5321 (SMTP RFC)
