# SMB Enumeration (139, 445)

## Quick setup - Set target IP
```bash
export IP=$IP
```

## Enumerate SMB with enum4linux-ng (comprehensive)
```bash
enum4linux-ng -A $IP
```

## Enumerate SMB with nmap scripts
```bash
nmap --script=smb-enum* -p 139,445 $IP
```

## Enumerate SMB host with netexec
```bash
netexec smb $IP
```

## List SMB shares as null user
```bash
smbclient -N -L \\\\$IP\\
```

## List SMB shares with netexec (null/guest session)
```bash
# -u '' for null session OR -u 'guest' for guest account
netexec smb $IP -u '' -p '' --shares
```

## Connect to specific SMB share
```bash
smbclient \\\\$IP\\sharename -U username
```

## Mount SMB share locally
```bash
mount -t cifs //$IP/sharename /mnt/smb -o username=user,password=pass
```

## Enumerate SMB users with rpcclient
```bash
rpcclient -U "" -N $IP -c enumdomusers
```

## Download all files from SMB share recursively
```bash
smbget -R smb://$IP/sharename -U username
```

---

# SMB Enumeration Methodology

## Tool Selection

**enum4linux-ng**: Best for comprehensive Windows/Samba enumeration. Use first for broad discovery.

**netexec (formerly crackmapexec)**: Fast for checking multiple hosts, great for null sessions and password spraying.

**nmap scripts**: Use when you need specific NSE functionality or already running nmap.

**smbclient**: Manual exploration and file operations once you have access.

**rpcclient**: Detailed RPC enumeration when other tools don't give enough info.

## Common Attack Path

1. Test for null sessions (no credentials)
2. Test for guest account access
3. If either works, enumerate users and shares
4. Check share permissions and contents
5. Look for sensitive files (passwords, configs, backups)
6. Extract credentials for lateral movement

## Null Session Enumeration

Try these in order:
- netexec with empty user/pass
- netexec with guest account
- smbclient with -N flag
- rpcclient with empty credentials

If null sessions work, you can often enumerate:
- User accounts
- Group memberships
- Share names and permissions
- Password policy
- Domain information

## Authentication Required

If null sessions fail, you'll need credentials. Try:
- Default credentials (admin/admin, administrator/password, etc.)
- Credentials found from other services
- Password spraying with common passwords
- Kerberos attacks (AS-REP roasting if AD environment)

## Common SMB Ports

- 139: SMB over NetBIOS
- 445: SMB over TCP (direct hosting)

Most modern systems use 445, but check both.

## Troubleshooting

**enum4linux-ng hangs**: Try with `-oY` for YAML output or kill and use individual flags.

**"NT_STATUS_ACCESS_DENIED"**: Null sessions blocked, need credentials.

**"Connection reset"**: Firewall blocking, wrong port, or service down.

**SMBv1 disabled**: Modern Windows disables SMBv1. Use tools that support SMBv2/3 (like netexec).

---

# References
- https://0xdf.gitlab.io/cheatsheets/smb-enum
- https://book.hacktricks.xyz/network-services-pentesting/pentesting-smb
